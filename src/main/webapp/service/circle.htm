
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport"
	content="width=device-width,minimum-scale=1,user-scalable=no,maximum-scale=1,initial-scale=1" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta name="format-detection" content="telephone=no" />
<link href="/img/favicon.ico" rel="shortcut icon" />
<title>大转盘</title>
<meta name="keywords" content="互道科技" />
<meta name="description" content="互道科技" />
<link href="./style/common.css" media="screen" rel="stylesheet"
	type="text/css" />
<link href="./style/jquery.css" media="screen" rel="stylesheet"
	type="text/css" />
<link href="./style/alertify.css" media="screen" rel="stylesheet"
	type="text/css" />
<script src="./js/mobile.js" type="text/javascript"></script>
<script src="./js/jquery-1.7.2.min.js" type="text/javascript"></script>
<meta content="authenticity_token" name="csrf-param" />
<meta content="7iGgqMTWMyuFWGNoA0PpmMoeh66xEs29BDIEdaL9V1A="
	name="csrf-token" />
</head>
<body>

	<style>
.cover {
	width: 100%;
	max-width: 480px;
	margin: 0 auto;
	position: relative;
}

.cover img {
	width: 100%;
}

#outer-cont {
	position: absolute;
	width: 100%;
	top: 20px; /* -moz-transform: rotate(-5deg);
		-webkit-transform: rotate(-5deg);
		-o-transform: rotate(-5deg);
		-ms-transform: rotate(-5deg);
		transform: rotate(-5deg); */
}

#inner-cont {
	position: absolute;
	width: 100%;
	top: 90px; /* -moz-transform: rotate(-5deg);
		-webkit-transform: rotate(-5deg);
		-o-transform: rotate(-5deg);
		-ms-transform: rotate(-5deg);
		transform: rotate(-5deg); */
}

#outer {
	width: 300px;
	max-width: 300px;
	height: 300px;
	margin: 0 auto;
}

#inner {
	width: 112px;
	max-width: 112px;
	height: 142px;
	margin: 0 auto;
	cursor: pointer;
}

#outer img,#inner img {
	display: block;
	margin: 0 auto;
}

.content {
	margin-top: 100px;
	padding: 0 15px;
}

.content .desc {
	font-weight: bold;
	border-bottom: 1px dashed #000;
	padding: 12px 0px;
}

.content .url {
	padding: 10px 0px;
}

.loading-mask {
	width: 100%;
	height: 100%;
	position: fixed;
	background: rgba(0, 0, 0, 0.6);
	z-index: 100;
	left: 0px;
	top: 0px;
}

.ui-icon {
	
}
</style>



	<div id="panelLottery">
		<div class="cover">
			<img src="./img/mobile_bg1.jpg" />
		</div>
		<div id="outer-cont">
			<div id="outer">
				<img src="./img/pan3.png" />
			</div>
		</div>
		<div id="inner-cont">
			<div id="inner">
				<img src="./img/pan-2.png" />
			</div>
		</div>
		<div id="msgss"></div>
		<div class="content">
			<p class="desc">
				兑奖说明<span style="color: red;">（亲，中奖后请务必输入您的手机号或牢记您的SN码，否则可能无法领奖喔！）</span>
			</p>
			<p>一等奖：兰博基尼Reventon一辆。奖品数量：10</p>
			<p>二等奖：保时捷卡宴一辆。奖品数量：30</p>
			<p>三等奖：路虎极光一辆。奖品数量：100</p>
			<p class="url">
				<a href="/weixin-server/api/weixin/list-prize">点击查看我获得的奖品&gt;&gt;&gt;</a>
			</p>
		</div>
	</div>
	<!--弹出框-->
	<div id="promptMsg"
		class="ui-dialog-contain ui-corner-all ui-overlay-shadow"
		style="display: none">
		<div class="ui-corner-top ui-header ui-bar-d">
			<a title="Close"
				class="ui-btn-left ui-btn ui-shadow ui-btn-corner-all ui-btn-icon-notext ui-btn-up-d"
				href="10039?anid=80&wxmuid=10002&wxuid=18586"> <span
				class="ui-btn-inner ui-btn-corner-all"> <span
					class="ui-btn-text">Close</span> <span
					class="ui-icon ui-icon-delete ui-icon-shadow">&nbsp;</span>
			</span>
			</a>
			<h3 class="ui-title">恭喜你！中奖了</h3>
		</div>
		<div class="ui-corner-bottom ui-content ui-body-c">
			<p style="font-weight: bold;">
				你中的是<span id="prizetype"></span>，兑奖SN码：<span id="sncode"></span>
			</p>
			<p>请留下您的手机号码，我们的工作人员会联系你发奖</p>
			<div class="form-inline">
				<label>您的手机号：</label> <input
					class="ui-input-text ui-body-c ui-corner-all ui-shadow-inset"
					id="tel" name="tel" type="text">
				<div>
					<div
						class="ui-btn ui-shadow ui-btn-corner-all ui-submit ui-btn-up-b">
						<span class="ui-btn-inner ui-btn-corner-all"> <span
							class="ui-btn-text">提交</span>
						</span>
						<button class="ui-btn-hidden" id="save-btn" type="submit"
							onClick="this.disabled=true;submitMobile();">提交</button>
					</div>
				</div>
			</div>
		</div>
	</div>
	<section id="alertEle"
		class="alertify-dialog is-alertify-dialog-showing"
		style="display: none;">
	<div class="alertify-dialog-inner">
		<article class="alertify-inner">
		<p class="alertify-message" id="alertEleMsg"></p>
		<nav class="alertify-buttons">
		<button id="alertify-ok" class="alertify-button alertify-button-ok"
			type="button" role="button"
			onClick="$_(&#39;alertEle&#39;).style.display=&#39;none&#39;;">确定</button>
		</nav> </article>
		<a href="10039?anid=80&wxmuid=10002&wxuid=18586"
			class="alertify-resetFocus" id="alertify-resetFocus">Reset Focus</a>
	</div>
	</section>

	<script type="text/javascript">
		$_("save-btn").disabled = false;
		var Rotate = {};
		Rotate.init = function () {
			Rotate.speed = 6; //转速
			Rotate.prizeList = {'1' : '一等奖', '2' : '二等奖', '3' : '三等奖', '4' : '四等奖', '5' : '五等奖', '6' : '六等奖'};
			Rotate.isRun = false;
			Rotate.isStop = false;
			Rotate.isFaild = false;
			window.winmsg = null;
		};
		Rotate.getPrizeDeg = function (prizeid) {
			if(Rotate.prizeList[prizeid]){
				if (Rotate.prizeList[prizeid] == '一等奖') return 8;
				if (Rotate.prizeList[prizeid] == '二等奖') return 248;
				if (Rotate.prizeList[prizeid] == '三等奖') return 128;
				if (Rotate.prizeList[prizeid] == '四等奖') return 308;
				if (Rotate.prizeList[prizeid] == '五等奖') return 188;
				if (Rotate.prizeList[prizeid] == '六等奖') return 68;
			}
			return 160;
		}
		Rotate.run = function () {
			Rotate.init();
			Rotate.isRun = true;
			var deg = 0;
			var deg_increment = 18;
			var runCount = 0;

			//开始旋转
			Rotate.getWinResult();
			//获取摇奖结果
			setTimeout(ratateing, Rotate.speed);

			function ratateing() {
				deg += deg_increment;
				Rotate.rotateY('outer', deg);

				if (deg == 360) {
					deg = 0;
					deg_increment = 12;
					if(runCount > 3){
						deg_increment = 4;
					}
					runCount++;
				}

				if(runCount < 4 || !Rotate.isStop){
					setTimeout(ratateing, Rotate.speed);
					return;
				}
				//检测中奖情况
				if(winmsg || Rotate.isFaild){
					checkWin();
				}
				else{
					setTimeout(ratateing, Rotate.speed);
				}
			}
			//判断中奖情况
			function checkWin(){
				if(Rotate.isFaild){//网络错误
					if(Rotate.getPrizeDeg(-1) == deg){
						alert_t('对不起，网络连接错误，请重试');
						Rotate.isRun = false;
						return;
					}
				}
				if(winmsg.iserror){//内部服务器错误
					if(Rotate.getPrizeDeg(-1) == deg){
						if(winmsg.errorid == "-100"){
							alert_t('您的抽奖次数已经用完');
						}else if(winmsg.errorid == "-101"){
							alert_t('您的当日抽奖次数已经用完');
						}else if(winmsg.errorid == "-104"){
							alert_t('对不起，活动已经停止');
						}else if(winmsg.errorid == "-401"){
							alert_t('对不起，活动已经结束');
						}else if(winmsg.errorid == "-999"){
							alert_t(winmsg.errorMsg);
						}else{
							alert_t('对不起，网络连接错误，请重试');
						}
						Rotate.isRun = false;
						return;
					}
				}
				if(winmsg.iswin){//中奖
					if(Rotate.getPrizeDeg(winmsg.prizeid) == deg){
						setTimeout(function(){
							Rotate.showPrompt();
							Rotate.isRun = false;
						}, 2000);
						return;
					}
					if(Rotate.getPrizeDeg(-1) - deg < 160){
						//Rotate.speed += 1;
					}
				}
				if(winmsg.isthank){//鼓励奖
					if(Rotate.getPrizeDeg(-1) == deg){
						Rotate.isRun = false;
						alert_t('对不起，您这次没有中奖');
						return;
					}
				}

				//继续选装
				setTimeout(ratateing, Rotate.speed);
			}
		};
		Rotate.showPrompt = function(){
			$_('prizetype').innerHTML = Rotate.prizeList[winmsg.prizeid];
			$_('sncode').innerHTML = winmsg.sn;
			$_('promptMsg').style.display = 'block';
			$_('panelLottery').style.display = 'none';
		};
		//向服务器请求抽奖
		Rotate.getWinResult = function () {
			$.ajax({
				type: "POST",
				contentType: "application/json",
				url: '/weixin-server/api/weixin/shake-prize?rand=' + Math.random(),
				dataType: 'json',
				timeout:30000,
				success: function (data) {
					alert(data);
					if (data) {
						window.winmsg = data.prize_info;
						Rotate.isStop = true;
					}else {
						Rotate.isFaild = true;
						Rotate.isStop = true;
					}
				},
				error: function(e){
					Rotate.isFaild = true;
					Rotate.isStop = true;
				}
			});

		};

		Rotate.rotateY = function (id, _deg) {
			var element = $_(id);
			element.style.MozTransform = 'rotateZ(' + _deg + 'deg)';
			element.style.WebkitTransform = 'rotateZ(' + _deg + 'deg)';
			element.style.OTransform = 'rotateZ(' + _deg + 'deg)';
			element.style.MsTransform = 'rotateZ(' + _deg + 'deg)';
			element.style.Transform = 'rotateZ(' + _deg + 'deg)';
		};

		$_('inner').onclick = function(){
			if(Rotate.isRun){
				return;
			}
			Rotate.run();
		};

		function submitMobile() {
			var tel = $_('tel').value;
			if (!(/^1[3|4|5|8][0-9]\d{8}$/.test(tel))) {
				alert_t('请输入正确的手机号码');
				$_("save-btn").disabled = false;
				return;
			}

			$.ajax({
				type: "POST",
				contentType: "application/json",
				url: 'prize?anid=80&wxmuid=10002&wxuid=18586&aid=10039&t=mobile&sn=' + winmsg.sn_code + '&acid=' + winmsg.activity_consume_id + '&mobile=' + tel + '&' + Math.random(),
				dataType: 'json',
				timeout:30000,
				success: function (data) {
					$_('promptMsg').style.display = 'none';
					$_('panelLottery').style.display = 'block';
					$_("save-btn").disabled = false;
					alert_t('信息提交成功，我们的工作人员稍后会联系您，请牢记您的SN码');
				},
				error: function(e){
					//alert(JSON.stringify(e));
				}
			});

		}
		function alert_t(msg){
			$_('alertEleMsg').innerHTML = msg;
			$_('alertEle').style.display='block';
		};
	</script>

	<p class="page-url">
		<a href="http://www.vcooline.com/" target="_blank"
			class="page-url-link">此功能由"互道科技"平台提供</a>
	</p>
</body>
</html>